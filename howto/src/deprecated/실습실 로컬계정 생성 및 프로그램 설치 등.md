실습실 로컬계정 생성 및 프로그램 설치 등
---

> 작성자: 이진우, 노윤미, 서장호

## 개요

수업에서 실습실PC 내의 계정을 요구하거나 모든 실습실PC에 프로그램 설치를 요구하는 경우가 있다.
이를 90대 정도의 PC에 하나하나 직접하기엔 너무 많은 시간과 에너지를 소비하게된다.
이를 위해 쉘스크립트(shell 기반에서 실행되는 코드)로 자동화하여 한번에 작업하는 방법에 대해 설명한다.

## 배경지식

실습실PC들에 ssh접속을 위한 ssh key가 있고, 
리눅스환경 혹은 리눅스환경처럼 사용할 수 있는 PC가 있어야한다.

이 작업을 위해서는 PC에 `bacchus-pcdb` 패키지가 설치되어 있어야 한다. 그리고,

* WOL 명령을 날리려면 WOL 명령을 수신하는 PC와 같은 네트워크상에 있어야 한다. 예를 들어 302동 실습실은 147.46.78.x 네트워크인데, 이 네트워크에 물려있어야 WOL 패킷이 잘 도착한다.
* 스크립트를 돌리려면 스크립트를 실행하는 PC와 같은 네트워크상에 있을 필요는 없지만, 적어도 학내망에서 작업해야 한다. 그리고 SSH 인증을 위한 개인키가 필요하다.

## wol(Wake On Lan)

WOL은 같은 게이트웨이에 있는 PC들에게 특정 패킷을 보내 꺼져있는 PC들을 원격으로 켜는 방식이다.

```bash
bacchus-pcdb-wakeonlan
```

하면 pcdb에 등록된 모든 PC를 켠다.

## 스크립트 돌리기

이 작업은 모든 실습실PC에 프로그램설치나 계정생성과 같은 일을 하는 단계이다.

* 실행하고자 하는 스크립트를 작성해서 별도의 파일로 만든다.

```bash
sudo apt update
sudo apt upgrade
```
* 스크립트를 실행할 실습실의 범위를 정한다. 따라서 아래 옵션이 결정된다.
  * `-h` 또는 `--hardware`: 하드웨어 실습실 PC
  * `-s` 또는 `--software`: 소프트웨어 실습실 PC
  * `-l` 또는 `--lounge`: 과방 PC
  * `-sh`: 하드웨어 실습실 및 소프트웨어 실습실 PC
  * `-a` 또는 `--all`: 모든 PC

* SSH 개인키를 준비한다. 아래 옵션이 결정된다.
  * `-i <개인키 위치>`

* 위 옵션과, 실행하고자 하는 스크립트를 인자로 하여 `bdo` 를 실행한다.


예를 들어서, 하실 및 소실에 어떤 스크립트를 실행시키려고 하면 이렇게 하면 된다.

```bash
bdo -sh -i ./lab-key ./my-script
```


## 작업완료 후

* 작업이 제대로 되었는지 확인해준다.(프로그램을 깔았다면 실행시켜보고, 계정을 발급했다면 로그인해보자)
  * `bdo` 는 SSH 접근이 비정상적인 exit status로 종료되었다면 오류를 갈무리해서 `bdo` 종료때 아래와 같이 요약해준다. 예를 들어서 두 대의 PC에 대한 접속이 exit status 255로 종료되었다면
      ```
      311-1-H06 147.46.78.58  255
      311-1-H07 147.46.78.53  255
      ```
* 작업한 PC들을 모두 종료해준다. 실행 코드에 `shutdown -h now`나 `halt`와 같은 명령어를 넣고 `bdo` 를 돌리면 한번에 모두 꺼줄 수 있다.
  * 물론 혹시 실습실을 쓰는 사람이 있는건 아닌지 잘 보아야 할 일이다.
  * `bacchus-shutdown` 패키지에 의해서, 밤 시간대에는 사용중이지 않은 PC는 자동적으로 꺼진다. 그러므로 신경쓰지 않아도 될 것 같기도...

## 작동 조건

지금까지 언급된 원격 조작법이 잘 작동하려면,

### WOL

각 PC의 BIOS 설정에서 Wake On Lan을 켜두어야 한다.

### 스크립트 돌리기

* 각 PC에 openssh 서버가 돌아가야 하고
* 보안을 위해 이 서버는 패스워드 인증 없이 공개 키 인증만 사용하도록 설정되어야 하며
* 로컬 계정 `bacchus`의 `authorized_keys` 에 바쿠스에서 관리하는 lab key의 공개키가 등록되어있어야 하며
* 이 lab key의 비밀키는 적절한 보안 수준에서 관리되어야 하고
* `bacchus` 에는 `sudo` 권한이 있으며
* `sudo` 권한을 행사할 때 별도의 패스워드 입력이 필요하지 않도록 설정해야 한다. (`visudo` 에서 `NOPASSWD` 설정)

## 팁

### 접속 테스트

스크립트 자리에 `/dev/null` 이라는 뻥 파일을 넣으면 스크립트 실행 대신 SSH 접속가능 여부를 테스트하는게 가능하다. 예를 들어 하드웨어 실습실 PC의 SSH 접속가능 여부를 확인하고 싶으면

```bash
bdo -h -i ./lab-key /dev/null
```

하고 나서 나중의 오류 요약을 보면 된다.

### Shutdown

만약 스크립트 실행이 오래 걸리는 작업을 새벽 시간대에 진행한다면, `systemctl stop bacchus-shutdown.timer` 를 먼저 한번 돌린 다음 원하는 스크립트를 돌리는게 좋다. 다른 PC가 작업을 수행하는 동안 다른 PC가 `bacchus-shutdown`에 의해 꺼져버릴 수 있기 때문이다.
